"""
å‘é‡åŒ–å’Œ Chroma å­˜å‚¨è¿‡ç¨‹è¯¦è§£
ä»åˆ‡å‰²åçš„æ–‡æ¡£åˆ°å‘é‡æ•°æ®åº“çš„å®Œæ•´æµç¨‹
"""

print("=" * 80)
print("å‘é‡åŒ–å’Œ Chroma å­˜å‚¨è¿‡ç¨‹è¯¦è§£")
print("=" * 80)

# ============================================================================
# Part 1: å®Œæ•´æµç¨‹æ¦‚è§ˆ
# ============================================================================
print("\n" + "=" * 80)
print("ğŸ“Š Part 1: å®Œæ•´æµç¨‹æ¦‚è§ˆ")
print("=" * 80)

print("""
ä»æ–‡æ¡£åˆ‡å‰²åˆ°å‘é‡æ•°æ®åº“çš„å®Œæ•´æµç¨‹ï¼š
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Step 1: æ–‡æ¡£åˆ‡å‰²
åŸå§‹æ–‡æ¡£ â†’ RecursiveCharacterTextSplitter â†’ 20 ä¸ª chunks
        (5000 tokens)                         (æ¯ä¸ª 250 tokens)

Step 2: å‘é‡åŒ– (Embedding)
æ¯ä¸ª chunk â†’ HuggingFace æ¨¡å‹ â†’ å‘é‡ (384ç»´)
   "äººå·¥æ™ºèƒ½æ˜¯..."  â†’  [0.12, -0.34, 0.56, ...]

Step 3: å­˜å…¥ Chroma
å‘é‡ + åŸæ–‡ + å…ƒæ•°æ® â†’ Chroma æ•°æ®åº“
                      â””â”€ æŒä¹…åŒ–å­˜å‚¨

Step 4: æ„å»ºç´¢å¼•
Chroma â†’ HNSW ç´¢å¼• â†’ å¿«é€Ÿè¿‘ä¼¼æ£€ç´¢
        (å±‚æ¬¡åŒ–å›¾ç»“æ„)

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
""")


# ============================================================================
# Part 2: Embedding æ¨¡å‹è¯¦è§£
# ============================================================================
print("\n" + "=" * 80)
print("ğŸ¤– Part 2: Embedding æ¨¡å‹ - HuggingFaceEmbeddings")
print("=" * 80)

print("""
ä½ çš„é¡¹ç›®é…ç½®ï¼š
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

self.embeddings = HuggingFaceEmbeddings(
    model_name="sentence-transformers/all-MiniLM-L6-v2",
    model_kwargs={'device': device},  # CPU æˆ– GPU
    encode_kwargs={'normalize_embeddings': True}  # å½’ä¸€åŒ–
)

æ¨¡å‹è¯´æ˜ï¼š
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

æ¨¡å‹åç§°: all-MiniLM-L6-v2
â”œâ”€ ç±»å‹: Sentence-BERT (åŒç¼–ç å™¨)
â”œâ”€ å‚æ•°é‡: 22M (è½»é‡çº§)
â”œâ”€ è¾“å‡ºç»´åº¦: 384 ç»´å‘é‡
â”œâ”€ è®­ç»ƒæ•°æ®: 10äº¿+ å¥å­å¯¹
â””â”€ ç‰¹ç‚¹: å¿«é€Ÿã€å‡†ç¡®ã€é€‚åˆè¯­ä¹‰æ£€ç´¢

å·¥ä½œåŸç†ï¼š
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

è¾“å…¥æ–‡æœ¬: "äººå·¥æ™ºèƒ½æ˜¯è®¡ç®—æœºç§‘å­¦çš„ä¸€ä¸ªåˆ†æ”¯"
    â†“
Tokenization (åˆ†è¯)
    â†“
Token IDs: [101, 782, 1435, 1819, 2510, 3221, ...]
    â†“
BERT Encoder (6 å±‚ Transformer)
    â†“
[CLS] Token çš„å‘é‡è¡¨ç¤º
    â†“
384 ç»´å‘é‡: [0.123, -0.456, 0.789, ...]
    â†“
L2 å½’ä¸€åŒ– (normalize_embeddings=True)
    â†“
æœ€ç»ˆå‘é‡: ||v|| = 1 (å•ä½å‘é‡)
""")


# ============================================================================
# Part 3: å‘é‡åŒ–è¿‡ç¨‹åˆ†æ­¥è§£æ
# ============================================================================
print("\n" + "=" * 80)
print("ğŸ” Part 3: å‘é‡åŒ–è¿‡ç¨‹ - é€æ­¥è§£æ")
print("=" * 80)

print("""
å‡è®¾æˆ‘ä»¬æœ‰ 3 ä¸ª chunksï¼š
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Chunk 1: "äººå·¥æ™ºèƒ½æ˜¯è®¡ç®—æœºç§‘å­¦çš„ä¸€ä¸ªåˆ†æ”¯ã€‚å®ƒè‡´åŠ›äº..."
Chunk 2: "æœºå™¨å­¦ä¹ æ˜¯äººå·¥æ™ºèƒ½çš„å­é¢†åŸŸã€‚å®ƒä½¿è®¡ç®—æœº..."
Chunk 3: "æ·±åº¦å­¦ä¹ ä½¿ç”¨å¤šå±‚ç¥ç»ç½‘ç»œæ¥å¤„ç†å¤æ‚çš„..."

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

å‘é‡åŒ–è¿‡ç¨‹ï¼ˆæ‰¹é‡å¤„ç†ï¼‰ï¼š
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

embeddings.embed_documents([chunk1, chunk2, chunk3])
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         HuggingFace Embedding æ¨¡å‹                        â”‚
â”‚         (sentence-transformers/all-MiniLM-L6-v2)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
        å†…éƒ¨å¤„ç†ï¼ˆæ¯ä¸ª chunkï¼‰ï¼š
                    â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Step 1: Tokenization                  â”‚
    â”‚ "äººå·¥æ™ºèƒ½..." â†’ [101, 782, 1435, ...] â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Step 2: è½¬æ¢ä¸º Token Embeddings       â”‚
    â”‚ Token IDs â†’ åˆå§‹å‘é‡è¡¨ç¤º               â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Step 3: BERT Encoder (6 å±‚)          â”‚
    â”‚ Self-Attention + Feed Forward         â”‚
    â”‚ æ¯å±‚æå–æ›´æ·±å±‚çš„è¯­ä¹‰                  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Step 4: Mean Pooling                  â”‚
    â”‚ æ‰€æœ‰ token å‘é‡çš„å¹³å‡ â†’ å¥å­å‘é‡      â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Step 5: L2 Normalization              â”‚
    â”‚ å‘é‡å½’ä¸€åŒ–åˆ°å•ä½é•¿åº¦                  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
        è¾“å‡ºï¼š3 ä¸ªå‘é‡
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Vector 1: [0.123, -0.456, 0.789, ..., 0.321]  (384ç»´)  â”‚
â”‚ Vector 2: [0.234, 0.567, -0.890, ..., 0.432]  (384ç»´)  â”‚
â”‚ Vector 3: [-0.345, 0.678, 0.901, ..., -0.543] (384ç»´)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å…³é”®ç‚¹ï¼š
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
âœ… æ¯ä¸ª chunk â†’ 1 ä¸ªå›ºå®šç»´åº¦çš„å‘é‡ (384ç»´)
âœ… è¯­ä¹‰ç›¸ä¼¼çš„æ–‡æœ¬ â†’ å‘é‡è·ç¦»è¿‘
âœ… å½’ä¸€åŒ–åå¯ç”¨ä½™å¼¦ç›¸ä¼¼åº¦å¿«é€Ÿæ¯”è¾ƒ
""")


# ============================================================================
# Part 4: Chroma æ•°æ®åº“å­˜å‚¨ç»“æ„
# ============================================================================
print("\n" + "=" * 80)
print("ğŸ’¾ Part 4: Chroma æ•°æ®åº“å­˜å‚¨ç»“æ„")
print("=" * 80)

print("""
Chroma.from_documents() æ‰§è¡Œçš„æ“ä½œï¼š
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Chroma.from_documents(
    documents=doc_splits,          # 20 ä¸ª chunks
    collection_name="rag-chroma",  # é›†åˆåç§°
    embedding=self.embeddings      # Embedding å‡½æ•°
)

å†…éƒ¨æµç¨‹ï¼š
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Step 1: åˆ›å»º/æ‰“å¼€é›†åˆ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Collection: "rag-chroma"             â”‚
â”‚ å…ƒæ•°æ®: embedding_dimension=384     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Step 2: æ‰¹é‡å‘é‡åŒ–
for chunk in doc_splits:
    vector = embeddings.embed_documents([chunk.page_content])
    â†“

Step 3: å­˜å‚¨æ•°æ®ï¼ˆæ¯ä¸ª chunkï¼‰
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ID: "chunk_1"                                           â”‚
â”‚ â”œâ”€ Vector: [0.123, -0.456, ..., 0.321]  (384ç»´)        â”‚
â”‚ â”œâ”€ Document: "äººå·¥æ™ºèƒ½æ˜¯è®¡ç®—æœºç§‘å­¦çš„ä¸€ä¸ªåˆ†æ”¯..."       â”‚
â”‚ â””â”€ Metadata: {                                          â”‚
â”‚      "source": "https://...",                           â”‚
â”‚      "chunk_index": 0,                                  â”‚
â”‚      "total_chunks": 20                                 â”‚
â”‚    }                                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ID: "chunk_2"                                           â”‚
â”‚ â”œâ”€ Vector: [0.234, 0.567, ..., 0.432]                  â”‚
â”‚ â”œâ”€ Document: "æœºå™¨å­¦ä¹ æ˜¯äººå·¥æ™ºèƒ½çš„å­é¢†åŸŸ..."           â”‚
â”‚ â””â”€ Metadata: {...}                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ID: "chunk_3"                                           â”‚
â”‚ â”œâ”€ Vector: [-0.345, 0.678, ..., -0.543]                â”‚
â”‚ â”œâ”€ Document: "æ·±åº¦å­¦ä¹ ä½¿ç”¨å¤šå±‚ç¥ç»ç½‘ç»œ..."             â”‚
â”‚ â””â”€ Metadata: {...}                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Step 4: æ„å»º HNSW ç´¢å¼•
å‘é‡ â†’ HNSW å›¾ç»“æ„ â†’ å¿«é€Ÿæ£€ç´¢
      (å±‚æ¬¡åŒ–å¯¼èˆªå°ä¸–ç•Œå›¾)

å­˜å‚¨ä½ç½®ï¼š
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
é»˜è®¤è·¯å¾„: ./chroma/  (æœ¬åœ°ç›®å½•)
â”œâ”€ collections/
â”‚  â””â”€ rag-chroma/
â”‚     â”œâ”€ data.parquet      # å‘é‡æ•°æ®
â”‚     â”œâ”€ metadata.json     # å…ƒæ•°æ®
â”‚     â””â”€ index.bin         # HNSW ç´¢å¼•
â””â”€ chroma.sqlite3          # SQLite æ•°æ®åº“
""")


# ============================================================================
# Part 5: HNSW ç´¢å¼•å·¥ä½œåŸç†
# ============================================================================
print("\n" + "=" * 80)
print("ğŸ”— Part 5: HNSW ç´¢å¼• - å¿«é€Ÿæ£€ç´¢çš„ç§˜å¯†")
print("=" * 80)

print("""
HNSW = Hierarchical Navigable Small World
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ä¸ºä»€ä¹ˆéœ€è¦ç´¢å¼•ï¼Ÿ
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
æš´åŠ›æœç´¢: O(n) - è®¡ç®—æŸ¥è¯¢å‘é‡ä¸æ‰€æœ‰å‘é‡çš„è·ç¦»
  â””â”€ 10000 ä¸ªå‘é‡ â†’ éœ€è¦è®¡ç®— 10000 æ¬¡è·ç¦»
  â””â”€ å¤ªæ…¢ï¼

HNSW ç´¢å¼•: O(log n) - å±‚æ¬¡åŒ–å›¾ç»“æ„å¯¼èˆª
  â””â”€ 10000 ä¸ªå‘é‡ â†’ åªéœ€æ£€æŸ¥çº¦ 20-30 ä¸ªèŠ‚ç‚¹
  â””â”€ å¿« 100+ å€ï¼

HNSW ç»“æ„ï¼ˆç®€åŒ–ç¤ºä¾‹ï¼‰ï¼š
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Layer 2 (æœ€ç¨€ç–)
  Vâ‚ â†â”€â”€â”€â”€â”€â”€â†’ Vâ‚… â†â”€â”€â”€â”€â”€â”€â†’ Vâ‚â‚‚
   â†“           â†“           â†“

Layer 1
  Vâ‚ â†â†’ Vâ‚ƒ â†â†’ Vâ‚… â†â†’ Vâ‚ˆ â†â†’ Vâ‚â‚‚
   â†“     â†“     â†“     â†“     â†“

Layer 0 (æœ€å¯†é›†)
  Vâ‚ â† Vâ‚‚ â† Vâ‚ƒ â† Vâ‚„ â† Vâ‚… â† Vâ‚† â† ... â† Vâ‚â‚‚
  æ‰€æœ‰å‘é‡éƒ½åœ¨è¿™ä¸€å±‚

æ£€ç´¢è¿‡ç¨‹ï¼š
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

æŸ¥è¯¢å‘é‡: Q = [0.2, -0.3, 0.5, ...]

Step 1: ä» Layer 2 å¼€å§‹ï¼ˆç²—ç•¥æœç´¢ï¼‰
  å…¥å£ç‚¹: Vâ‚
  â†’ è®¡ç®— dist(Q, Vâ‚), dist(Q, Vâ‚…), dist(Q, Vâ‚â‚‚)
  â†’ Vâ‚… æœ€è¿‘ â†’ è·³åˆ° Vâ‚…

Step 2: ä¸‹é™åˆ° Layer 1ï¼ˆä¸­ç­‰ç²¾åº¦ï¼‰
  ä» Vâ‚… å¼€å§‹
  â†’ æ£€æŸ¥é‚»å±… Vâ‚ƒ, Vâ‚ˆ
  â†’ Vâ‚ˆ æœ€è¿‘ â†’ è·³åˆ° Vâ‚ˆ

Step 3: ä¸‹é™åˆ° Layer 0ï¼ˆé«˜ç²¾åº¦ï¼‰
  ä» Vâ‚ˆ å¼€å§‹
  â†’ æ£€æŸ¥æ‰€æœ‰é‚»å±…
  â†’ æ‰¾åˆ°æœ€è¿‘çš„ K ä¸ªå‘é‡

è¿”å›ç»“æœ: Top K æœ€ç›¸ä¼¼çš„ chunks

é€Ÿåº¦å¯¹æ¯”ï¼š
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
æš´åŠ›æœç´¢: 10000 æ¬¡è·ç¦»è®¡ç®— â†’ 100ms
HNSW ç´¢å¼•: 20-30 æ¬¡è·ç¦»è®¡ç®— â†’ 1ms  â† å¿« 100 å€ï¼
""")


# ============================================================================
# Part 6: æ£€ç´¢è¿‡ç¨‹è¯¦è§£
# ============================================================================
print("\n" + "=" * 80)
print("ğŸ” Part 6: æ£€ç´¢è¿‡ç¨‹ - ä»æŸ¥è¯¢åˆ°ç»“æœ")
print("=" * 80)

print("""
ç”¨æˆ·æŸ¥è¯¢: "ä»€ä¹ˆæ˜¯æœºå™¨å­¦ä¹ ï¼Ÿ"
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Step 1: æŸ¥è¯¢å‘é‡åŒ–
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
"ä»€ä¹ˆæ˜¯æœºå™¨å­¦ä¹ ï¼Ÿ"
    â†“
embeddings.embed_query("ä»€ä¹ˆæ˜¯æœºå™¨å­¦ä¹ ï¼Ÿ")
    â†“
Query Vector: [0.345, -0.678, 0.234, ...]  (384ç»´)


Step 2: HNSW è¿‘ä¼¼æœç´¢
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
vectorstore.similarity_search(
    query="ä»€ä¹ˆæ˜¯æœºå™¨å­¦ä¹ ï¼Ÿ",
    k=20  # è¿”å› Top 20
)
    â†“
Chroma å†…éƒ¨:
1. æŸ¥è¯¢å‘é‡åŒ–
2. HNSW å›¾å¯¼èˆª
3. è®¡ç®—ä½™å¼¦ç›¸ä¼¼åº¦
    â†“
è¿”å› Top 20 chunks:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Chunk ID â”‚  Score  â”‚        Content             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ chunk_5  â”‚  0.92   â”‚ "æœºå™¨å­¦ä¹ æ˜¯äººå·¥æ™ºèƒ½çš„..." â”‚
â”‚ chunk_2  â”‚  0.88   â”‚ "äººå·¥æ™ºèƒ½åŒ…æ‹¬æœºå™¨å­¦ä¹ ..." â”‚
â”‚ chunk_11 â”‚  0.85   â”‚ "ç›‘ç£å­¦ä¹ æ˜¯æœºå™¨å­¦ä¹ ..."   â”‚
â”‚ ...      â”‚  ...    â”‚ ...                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


Step 3: CrossEncoder é‡æ’ï¼ˆä½ çš„é¡¹ç›®ç‰¹è‰²ï¼‰
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
reranker.rerank(query, top_20_chunks, top_k=5)
    â†“
æ¯ä¸ª chunk é‡æ–°æ‰“åˆ†ï¼ˆæ·±åº¦äº¤äº’ï¼‰
    â†“
æœ€ç»ˆ Top 5:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Chunk ID â”‚  Score  â”‚        Content             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ chunk_5  â”‚  8.45   â”‚ "æœºå™¨å­¦ä¹ æ˜¯äººå·¥æ™ºèƒ½çš„..." â”‚
â”‚ chunk_11 â”‚  7.89   â”‚ "ç›‘ç£å­¦ä¹ æ˜¯æœºå™¨å­¦ä¹ ..."   â”‚
â”‚ chunk_2  â”‚  7.23   â”‚ "äººå·¥æ™ºèƒ½åŒ…æ‹¬æœºå™¨å­¦ä¹ ..." â”‚
â”‚ chunk_14 â”‚  6.78   â”‚ "æ·±åº¦å­¦ä¹ æ˜¯æœºå™¨å­¦ä¹ ..."   â”‚
â”‚ chunk_8  â”‚  6.12   â”‚ "å¼ºåŒ–å­¦ä¹ å…è®¸..."         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


Step 4: è¿”å›ç»™ LLM
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
context = "\\n\\n".join([chunk.page_content for chunk in top_5])
    â†“
LLM ç”Ÿæˆç­”æ¡ˆ
""")


# ============================================================================
# Part 7: å…³é”®æŠ€æœ¯ç»†èŠ‚
# ============================================================================
print("\n" + "=" * 80)
print("âš™ï¸  Part 7: å…³é”®æŠ€æœ¯ç»†èŠ‚")
print("=" * 80)

print("""
1. ä¸ºä»€ä¹ˆè¦å½’ä¸€åŒ–å‘é‡ï¼Ÿ
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
encode_kwargs={'normalize_embeddings': True}

åŸå§‹å‘é‡: [1.23, -4.56, 7.89, ...]  # é•¿åº¦ä¸ä¸€
å½’ä¸€åŒ–å: [0.12, -0.45, 0.78, ...]  # é•¿åº¦ = 1

å¥½å¤„:
âœ… ä½™å¼¦ç›¸ä¼¼åº¦ = ç‚¹ç§¯ï¼ˆè®¡ç®—æ›´å¿«ï¼‰
âœ… æ‰€æœ‰å‘é‡åœ¨åŒä¸€å°ºåº¦ä¸Š
âœ… é¿å…é•¿åº¦å½±å“ç›¸ä¼¼åº¦è®¡ç®—


2. ä½™å¼¦ç›¸ä¼¼åº¦ vs æ¬§æ°è·ç¦»
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ä½™å¼¦ç›¸ä¼¼åº¦ï¼ˆä½ çš„é¡¹ç›®ä½¿ç”¨ï¼‰â­:
  similarity = vâ‚ Â· vâ‚‚ / (||vâ‚|| Ã— ||vâ‚‚||)
  èŒƒå›´: [-1, 1]ï¼Œ1 è¡¨ç¤ºå®Œå…¨ç›¸åŒ
  ç‰¹ç‚¹: å…³æ³¨æ–¹å‘ï¼Œå¿½ç•¥é•¿åº¦

æ¬§æ°è·ç¦»:
  distance = âˆšÎ£(vâ‚áµ¢ - vâ‚‚áµ¢)Â²
  èŒƒå›´: [0, âˆ]ï¼Œ0 è¡¨ç¤ºå®Œå…¨ç›¸åŒ
  ç‰¹ç‚¹: å…³æ³¨ç»å¯¹ä½ç½®å·®å¼‚

å½’ä¸€åŒ–åï¼Œä¸¤è€…ç­‰ä»·ï¼


3. æ‰¹é‡å¤„ç†ä¼˜åŒ–
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ä¸æ¨èï¼ˆæ…¢ï¼‰:
for chunk in chunks:
    vector = embed_documents([chunk])  # å•ç‹¬å¤„ç†
    
æ¨èï¼ˆå¿« 10 å€ï¼‰â­:
vectors = embed_documents(chunks)  # æ‰¹é‡å¤„ç†
  â””â”€ GPU å¹¶è¡Œè®¡ç®—
  â””â”€ å‡å°‘æ¨¡å‹åŠ è½½å¼€é”€


4. å†…å­˜ä¼˜åŒ–
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

å‘é‡ç»´åº¦é€‰æ‹©:
  384 ç»´ (all-MiniLM-L6-v2)   â† ä½ çš„é¡¹ç›® â­
  â””â”€ å¹³è¡¡ï¼šå‡†ç¡®ç‡ vs å­˜å‚¨

  768 ç»´ (BERT-base)
  â””â”€ æ›´å‡†ç¡®ä½†å­˜å‚¨ç¿»å€

  1024 ç»´ (large models)
  â””â”€ æœ€å‡†ç¡®ä½†å­˜å‚¨ 3 å€

å­˜å‚¨è®¡ç®—:
20 ä¸ª chunks Ã— 384 ç»´ Ã— 4 bytes = 30KB
1000 ä¸ª chunks Ã— 384 ç»´ Ã— 4 bytes = 1.5MB
  â””â”€ éå¸¸é«˜æ•ˆï¼
""")


# ============================================================================
# Part 8: å®Œæ•´ä»£ç æµç¨‹
# ============================================================================
print("\n" + "=" * 80)
print("ğŸ’» Part 8: å®Œæ•´ä»£ç æµç¨‹æ€»ç»“")
print("=" * 80)

print("""
ä½ çš„é¡¹ç›®å®Œæ•´æµç¨‹ï¼š
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

# 1. åˆå§‹åŒ– Embedding æ¨¡å‹
embeddings = HuggingFaceEmbeddings(
    model_name="sentence-transformers/all-MiniLM-L6-v2",
    model_kwargs={'device': 'cpu'},
    encode_kwargs={'normalize_embeddings': True}
)

# 2. æ–‡æ¡£åˆ‡å‰²
text_splitter = RecursiveCharacterTextSplitter.from_tiktoken_encoder(
    chunk_size=250,
    chunk_overlap=50  # â† ä½ åˆšä¿®æ”¹çš„
)
doc_splits = text_splitter.split_documents(docs)

# 3. å‘é‡åŒ– + å­˜å‚¨åˆ° Chroma
vectorstore = Chroma.from_documents(
    documents=doc_splits,      # è¾“å…¥: 20 ä¸ª chunks
    collection_name="rag-chroma",
    embedding=embeddings       # å‘é‡åŒ–å‡½æ•°
)
# â†“ å†…éƒ¨è‡ªåŠ¨å®Œæˆ:
#   - æ‰¹é‡å‘é‡åŒ–: chunks â†’ 384ç»´å‘é‡
#   - å­˜å‚¨: å‘é‡ + åŸæ–‡ + å…ƒæ•°æ®
#   - æ„å»º HNSW ç´¢å¼•

# 4. åˆ›å»ºæ£€ç´¢å™¨
retriever = vectorstore.as_retriever()

# 5. æ£€ç´¢
docs = retriever.get_relevant_documents("ä»€ä¹ˆæ˜¯æœºå™¨å­¦ä¹ ï¼Ÿ")
# â†“ å†…éƒ¨æµç¨‹:
#   - æŸ¥è¯¢å‘é‡åŒ–
#   - HNSW å¿«é€Ÿæ£€ç´¢
#   - è¿”å› Top K chunks

# 6. CrossEncoder é‡æ’ï¼ˆå¯é€‰ï¼Œä½ çš„é¡¹ç›®æœ‰ï¼‰
reranked = crossencoder.rerank(query, docs, top_k=5)

# 7. å–‚ç»™ LLM ç”Ÿæˆç­”æ¡ˆ
answer = llm.generate(context=docs, question=query)

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
""")


# ============================================================================
# Part 9: æ€§èƒ½ä¼˜åŒ–å»ºè®®
# ============================================================================
print("\n" + "=" * 80)
print("ğŸš€ Part 9: æ€§èƒ½ä¼˜åŒ–å»ºè®®")
print("=" * 80)

print("""
å½“å‰é…ç½®è¯„åˆ†ï¼š
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

âœ… Embedding æ¨¡å‹: all-MiniLM-L6-v2  (è½»é‡é«˜æ•ˆ) â­â­â­â­â­
âœ… å‘é‡å½’ä¸€åŒ–: True                 (ä½™å¼¦ç›¸ä¼¼åº¦ä¼˜åŒ–) â­â­â­â­â­
âœ… ç´¢å¼•ç±»å‹: HNSW                   (å¿«é€Ÿæ£€ç´¢) â­â­â­â­â­
âœ… Chunk overlap: 50                (ä¿æŒä¸Šä¸‹æ–‡) â­â­â­â­â­
âœ… CrossEncoder é‡æ’                (ç²¾å‡†æ’åº) â­â­â­â­â­

æ€»è¯„: ğŸ† ç”Ÿäº§çº§é…ç½®ï¼

å¯é€‰ä¼˜åŒ–ï¼ˆå¦‚éœ€è¿›ä¸€æ­¥æå‡ï¼‰ï¼š
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

1. GPU åŠ é€Ÿ
   model_kwargs={'device': 'cuda'}  # å‘é‡åŒ–é€Ÿåº¦ 10x â†‘

2. æ›´å¤§çš„ Embedding æ¨¡å‹ï¼ˆå¦‚éœ€æ›´é«˜å‡†ç¡®ç‡ï¼‰
   "BAAI/bge-large-en-v1.5"  # 1024ç»´ï¼Œå‡†ç¡®ç‡ +5%

3. æ‰¹é‡å¤§å°è°ƒæ•´
   batch_size=32  # åŠ å¿«å‘é‡åŒ–

4. Chroma æŒä¹…åŒ–é…ç½®
   persist_directory="./chroma_db"  # é¿å…é‡å¤å‘é‡åŒ–
""")


print("\n" + "=" * 80)
print("âœ… è§£æå®Œæˆï¼ä½ ç°åœ¨ç†è§£äº†ä»åˆ‡å‰²åˆ°å‘é‡æ•°æ®åº“çš„å®Œæ•´æµç¨‹")
print("=" * 80)
print()
